<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <title>Luisito-Wichin Admin</title>
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;margin:22px;max-width:720px}
    h1{margin:0 0 12px;font-size:28px}
    .card{border:1px solid #e6e6e6;border-radius:16px;padding:16px}
    .row{margin:12px 0}
    label{display:block;font-weight:800;margin:0 0 6px}
    input{width:100%;font:inherit;padding:12px;border-radius:12px;border:1px solid #bbb}
    button{width:100%;font:inherit;padding:14px;border-radius:12px;border:0;cursor:pointer;background:#111;color:#fff;font-weight:900}
    #current{font-size:16px}
    #current code{background:#f5f5f5;padding:2px 6px;border-radius:8px}
  </style>
</head>
<body>
  <!-- build:20260204-050742 -->
  <h1>Luisito-Wichin Admin</h1>
  <div class="card">
    <div class="row" id="current">Current URL: <code>Loading...</code></div>

    <div class="row">
      <label for="url">New URL</label>
      <input id="url" placeholder="https://..." autocomplete="off" />
    </div>

    <div class="row">
      <button id="publish" type="button">Publish</button>
    </div>
  </div>

<script>
(function () {
  var elCurrent = document.getElementById('current');
  var elUrl = document.getElementById('url');
  var elPublish = document.getElementById('publish');

  var TOKEN_KEY = 'qr_admin_token_v2';

  function nowUtcNoMs() {
    var iso = new Date().toISOString(); // YYYY-MM-DDTHH:mm:ss.sssZ
    return iso.slice(0, 19) + 'Z';      // YYYY-MM-DDTHH:mm:ssZ
  }

  function parseOwnerRepoFolder() {
    // https://{owner}.github.io/{repo}/{folder}/admin/
    var hostParts = String(location.host || '').split('.');
    var owner = (hostParts[0] || '').trim();
    var parts = String(location.pathname || '').split('/').filter(Boolean); // [repo, folder, admin]
    var repo = (parts[0] || '').trim();
    var folder = (parts[1] || 'Luisito-Wichin').trim();
    return { owner: owner, repo: repo, folder: folder };
  }

  function safePath(path) {
    return String(path).split('/').map(encodeURIComponent).join('/');
  }

  function startsWithHttp(url) {
    url = String(url || '').trim().toLowerCase();
    return url.indexOf('http://') === 0 || url.indexOf('https://') === 0;
  }

  function setCurrentText(text) {
    elCurrent.innerHTML = 'Current URL: <code>' + text + '</code>';
  }

  function loadCurrent() {
    var u = new URL('../target.json', location.href);
    u.searchParams.set('b', String(Date.now()));
    fetch(u.toString(), { cache: 'no-store' })
      .then(function (res) {
        if (!res.ok) throw new Error('HTTP ' + res.status);
        return res.json();
      })
      .then(function (data) {
        var cur = (data && typeof data.url === 'string') ? data.url.trim() : '';
        setCurrentText(cur || '(empty)');
        if (cur) elUrl.value = cur;
      })
      .catch(function () {
        setCurrentText('(failed to load)');
      });
  }

  function publish() {
    var dest = String(elUrl.value || '').trim();
    if (!startsWithHttp(dest)) {
      alert('Enter a valid URL starting with http:// or https://');
      return;
    }

    var token = String(localStorage.getItem(TOKEN_KEY) || '').trim();
    if (!token) {
      token = String(prompt('Paste GitHub token (saved on this PC).', '') || '').trim();
      if (!token) return;
      localStorage.setItem(TOKEN_KEY, token);
    }

    var info = parseOwnerRepoFolder();
    if (!info.owner || !info.repo) {
      alert('Could not determine owner/repo from this URL.');
      return;
    }

    var branch = 'main';
    var filePath = info.folder + '/target.json';
    var apiBase = 'https://api.github.com';

    var headers = {
      'Accept': 'application/vnd.github+json',
      'Authorization': 'Bearer ' + token,
      'X-GitHub-Api-Version': '2022-11-28'
    };

    elPublish.disabled = true;
    elPublish.textContent = 'Publishing...';

    var getUrl = apiBase + '/repos/' + info.owner + '/' + info.repo + '/contents/' + safePath(filePath) + '?ref=' + encodeURIComponent(branch);
    fetch(getUrl, { headers: headers })
      .then(function (res) {
        if (!res.ok) throw new Error('GitHub GET failed (' + res.status + ')');
        return res.json();
      })
      .then(function (cur) {
        if (!cur || !cur.sha) throw new Error('Missing sha');
        var json = JSON.stringify({ url: dest, updatedUtc: nowUtcNoMs() }, null, 2) + '\n';
        var body = {
          message: 'Update ' + filePath,
          content: btoa(unescape(encodeURIComponent(json))),
          sha: cur.sha,
          branch: branch
        };

        var putUrl = apiBase + '/repos/' + info.owner + '/' + info.repo + '/contents/' + safePath(filePath);
        return fetch(putUrl, {
          method: 'PUT',
          headers: Object.assign({}, headers, { 'Content-Type': 'application/json' }),
          body: JSON.stringify(body)
        });
      })
      .then(function (res) {
        if (!res.ok) {
          return res.text().then(function (t) { throw new Error('GitHub PUT failed (' + res.status + '): ' + t); });
        }
        setCurrentText(dest);
        alert('Published. Wait 30-90 seconds for Pages to update.');
      })
      .catch(function (e) {
        alert('Publish failed: ' + (e && e.message ? e.message : String(e)));
      })
      .finally(function () {
        elPublish.disabled = false;
        elPublish.textContent = 'Publish';
      });
  }

  elPublish.addEventListener('click', publish);
  loadCurrent();
})();
</script>
</body>
</html>
