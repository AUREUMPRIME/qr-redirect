<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Luisito-Wichin Admin</title>
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;margin:24px;line-height:1.35;max-width:820px}
    h1{margin:0 0 12px}
    .card{border:1px solid #e5e5e5;border-radius:16px;padding:16px}
    .row{margin:12px 0}
    label{display:block;font-weight:700;margin:0 0 6px}
    input{width:100%;font:inherit;padding:12px;border-radius:12px;border:1px solid #bbb}
    button{width:100%;font:inherit;padding:14px;border-radius:12px;border:0;cursor:pointer;background:#111;color:#fff;font-weight:800}
    #current{font-size:16px}
    #current code{background:#f5f5f5;padding:2px 6px;border-radius:8px}
    .muted{color:#555;font-size:13px;margin-top:10px}
  </style>
</head>
<body>
  <h1>Luisito-Wichin Admin</h1>

  <div class="card">
    <div class="row" id="current">Current URL: <code>Loading...</code></div>

    <div class="row">
      <label for="url">New URL</label>
      <input id="url" placeholder="https://..." autocomplete="off" />
    </div>

    <div class="row">
      <button id="publish" type="button">Publish</button>
    </div>

    <div class="muted">
      First time you click Publish, you will be asked for a GitHub token in a popup (then it is remembered on this PC).
    </div>
  </div>

<script>
(() => {
  const elCurrent = document.getElementById('current');
  const elUrl = document.getElementById('url');
  const elPublish = document.getElementById('publish');

  function nowUtc() {
    return new Date().toISOString().replace(/\\.\d{3}Z$/, 'Z');
  }

  function parseOwnerRepoFolder() {
    // Pages: https://{owner}.github.io/{repo}/{folder}/admin/
    const owner = (location.host.split('.')[0] || '').trim();
    const parts = location.pathname.split('/').filter(Boolean); // [repo, folder, admin]
    const repo = (parts[0] || '').trim();
    const folder = (parts[1] || 'Luisito-Wichin').trim();
    return { owner, repo, folder };
  }

  function safePath(path) {
    return path.split('/').map(encodeURIComponent).join('/');
  }

  async function loadCurrent() {
    try {
      const u = new URL('../target.json', location.href);
      u.searchParams.set('b', String(Date.now()));
      const res = await fetch(u.toString(), { cache: 'no-store' });
      if (!res.ok) throw new Error('HTTP ' + res.status);
      const data = await res.json();
      const cur = (data && typeof data.url === 'string') ? data.url.trim() : '';
      elCurrent.innerHTML = 'Current URL: <code>' + (cur || '(empty)') + '</code>';
      if (cur) elUrl.value = cur;
    } catch (e) {
      elCurrent.innerHTML = 'Current URL: <code>(failed to load)</code>';
    }
  }

  async function publish() {
    const dest = (elUrl.value || '').trim();
    if (!/^https?:\\/\\//i.test(dest)) {
      alert('Please enter a valid URL starting with http:// or https://');
      return;
    }

    const tokenKey = 'qr_admin_github_token_v1';
    let token = (localStorage.getItem(tokenKey) || '').trim();
    if (!token) {
      token = prompt('Paste your GitHub token (repo contents: read/write). This will be saved on this PC.', '') || '';
      token = token.trim();
      if (!token) return;
      localStorage.setItem(tokenKey, token);
    }

    const { owner, repo, folder } = parseOwnerRepoFolder();
    if (!owner || !repo) {
      alert('Could not determine owner/repo from this URL.');
      return;
    }

    const branch = 'main';
    const filePath = folder + '/target.json';
    const apiBase = 'https://api.github.com';

    const headers = {
      'Accept': 'application/vnd.github+json',
      'Authorization': 'Bearer ' + token,
      'X-GitHub-Api-Version': '2022-11-28'
    };

    try {
      elPublish.disabled = true;
      elPublish.textContent = 'Publishing...';

      const getUrl = apiBase + '/repos/' + owner + '/' + repo + '/contents/' + safePath(filePath) + '?ref=' + encodeURIComponent(branch);
      const getRes = await fetch(getUrl, { headers });
      if (!getRes.ok) throw new Error('GitHub GET failed (' + getRes.status + ')');

      const cur = await getRes.json();
      const sha = cur && cur.sha;
      if (!sha) throw new Error('Missing sha');

      const body = {
        message: 'Update ' + filePath,
        content: btoa(unescape(encodeURIComponent(JSON.stringify({ url: dest, updatedUtc: nowUtc() }, null, 2) + '\\n'))),
        sha,
        branch
      };

      const putUrl = apiBase + '/repos/' + owner + '/' + repo + '/contents/' + safePath(filePath);
      const putRes = await fetch(putUrl, {
        method: 'PUT',
        headers: { ...headers, 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      });

      if (!putRes.ok) {
        const txt = await putRes.text();
        throw new Error('GitHub PUT failed (' + putRes.status + '): ' + txt);
      }

      elCurrent.innerHTML = 'Current URL: <code>' + dest + '</code>';
      alert('Published. GitHub Pages may take 30-90 seconds to update.');

    } catch (e) {
      const msg = (e && e.message) ? e.message : String(e);
      alert('Publish failed: ' + msg + '\\n\\nIf token is wrong, refresh and try again.');
    } finally {
      elPublish.disabled = false;
      elPublish.textContent = 'Publish';
    }
  }

  elPublish.addEventListener('click', publish);
  loadCurrent();
})();
</script>
</body>
</html>
